<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>glhmm.glhmm &mdash; GLHMM 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GLHMM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GLHMM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">glhmm.glhmm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for glhmm.glhmm</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Gaussian Linear Hidden Markov Model</span>
<span class="sd">@author: Diego Vidaurre 2023</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="c1"># import scipy.spatial.distance as dist</span>

<span class="c1"># import glhmm.auxiliary as auxiliary</span>
<span class="c1"># import glhmm.io as io</span>
<span class="c1"># import glhmm.utils as utils</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">auxiliary</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">io_glhmm</span> <span class="k">as</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>

<div class="viewcode-block" id="glhmm"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm">[docs]</a><span class="k">class</span> <span class="nc">glhmm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Gaussian Linear Hidden Markov Model class to decode stimulus from data.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">    -----------</span>
<span class="sd">    K : int, default=10</span>
<span class="sd">        number of states in the model.</span>
<span class="sd">    covtype : str, {&#39;shareddiag&#39;, &#39;diag&#39;}, default &#39;shareddiag&#39;</span>
<span class="sd">        Type of covariance matrix. Choose &#39;shareddiag&#39; to have one diagonal covariance matrix for all states, </span>
<span class="sd">        or &#39;diag&#39; to have a diagonal full covariance matrix for each state.</span>
<span class="sd">    model_mean : str, {&#39;state&#39;, &#39;no&#39;}, default &#39;state&#39;</span>
<span class="sd">        Model for the mean. If `no` the mean of the timeseries will not be used to drive the states.</span>
<span class="sd">    model_beta : str, {&#39;state&#39;, &#39;no&#39;}, default &#39;state&#39;</span>
<span class="sd">        Model for the beta. If `no` the regression coefficients will not be used to drive the states.</span>
<span class="sd">    dirichlet_diag : int, default=10</span>
<span class="sd">        The value of the diagonal of the Dirichlet distribution for the transition probabilities. </span>
<span class="sd">        The higher the value, the more persistent the states will be. </span>
<span class="sd">        Note that this value is relative; the prior competes with the data, so if the timeseries is very long, </span>
<span class="sd">        the `dirichlet_diag` may have little effect unless it is set to a very large value.  </span>
<span class="sd">    connectivity : array_like of shape (n_states, n_states), optional</span>
<span class="sd">        Matrix of binary values defining the connectivity of the states. </span>
<span class="sd">        This parameter can only be used with a diagonal covariance matrix (i.e., `covtype=&#39;diag&#39;`).</span>
<span class="sd">    Pstructure : array_like, optional</span>
<span class="sd">        Binary matrix defining the allowed transitions between states.</span>
<span class="sd">        The default is a (n_states, n_states) matrix of all ones, allowing all possible transitions between states.</span>
<span class="sd">    Pistructure : array_like, optional</span>
<span class="sd">        Binary vector defining the allowed initial states.</span>
<span class="sd">        The default is a (n_states,) vector of all ones, allowing all states to be used as initial states.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This class requires the following modules: numpy, math, scipy, sys, warnings, copy, and time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">### Private methods</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">K</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># model options</span>
        <span class="n">covtype</span><span class="o">=</span><span class="s1">&#39;shareddiag&#39;</span><span class="p">,</span> 
        <span class="n">model_mean</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">model_beta</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">dirichlet_diag</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Pstructure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Pistructure</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">connectivity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">covtype</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">covtype</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Parameter connectivity can only be used with a diagonal covariance matrix&#39;</span><span class="p">)</span>
            <span class="n">connectivity</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;dirichlet_diag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirichlet_diag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connectivity</span>
        <span class="k">if</span> <span class="n">Pstructure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pstructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pstructure</span>
        <span class="k">if</span> <span class="n">Pistructure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pistructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">K</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>       
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pistructure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pistructure</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="c1">## Private methods</span>

    <span class="k">def</span> <span class="nf">__forward_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate state time courses for a collection of segments</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="n">ind</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">T</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="n">Xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="o">-</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">indices_Xi</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">Gamma_indices_to_Xi_indices</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>

            <span class="n">tt</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tt_xi</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">sc</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">compute_alpha_beta</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="n">tt</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>

            <span class="n">scale</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span>
            <span class="n">Gamma</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">a</span>
            <span class="n">Gamma</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[</span><span class="n">tt</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xi</span><span class="p">[</span><span class="n">tt_xi</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span> <span class="o">*</span> <span class="n">L</span><span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">:],:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span>
            <span class="n">Xi</span><span class="p">[</span><span class="n">tt_xi</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">Xi</span><span class="p">[</span><span class="n">tt_xi</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xi</span><span class="p">[</span><span class="n">tt_xi</span><span class="p">,:,:],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span>


    <span class="k">def</span> <span class="nf">__forward_backward_vp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate viterbi path for a collection of segments</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="n">ind</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">T</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">qstar</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">compute_qstar</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="n">tt</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
            <span class="n">vpath</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">qstar</span>

        <span class="k">return</span> <span class="n">vpath</span>   
    

    <span class="k">def</span> <span class="nf">__loglikelihood_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">cache</span><span class="p">):</span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">T</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shared_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sharedfull&#39;</span><span class="p">)</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>
        <span class="n">k_mean</span><span class="p">,</span><span class="n">k_beta</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span><span class="n">k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span><span class="p">:</span> <span class="n">k_mean</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span><span class="p">:</span> <span class="n">k_beta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">constant</span> <span class="o">=</span> <span class="o">-</span> <span class="n">q</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#+ q / 2 </span>

        <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shared_covmat</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span> 
                <span class="n">ldetWishB</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                    <span class="n">ldetWishB</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ldetWishB</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ldetWishB</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">PsiWish_alphasum</span> <span class="o">+=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">))</span>
                <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">PsiWish_alphasum</span>
                <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">logdet</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">])</span>
                <span class="n">ldetWishB</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">logdet</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;irate&#39;</span><span class="p">]</span>

            <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;PsiWish_alphasum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PsiWish_alphasum</span>
            <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;ldetWishB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldetWishB</span>
            <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span>

        <span class="k">elif</span> <span class="n">shared_covmat</span><span class="p">:</span>

            <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;PsiWish_alphasum&quot;</span><span class="p">]</span>
            <span class="n">ldetWishB</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;ldetWishB&quot;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">diagonal_covmat</span><span class="p">:</span> <span class="c1"># not shared_covmat</span>

            <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span> 
            <span class="n">ldetWishB</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="n">ldetWishB</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">ldetWishB</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ldetWishB</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span>
            <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># not shared_covmat, full matrix</span>

            <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
                <span class="n">PsiWish_alphasum</span> <span class="o">+=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">))</span>
            <span class="n">PsiWish_alphasum</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">PsiWish_alphasum</span>
            <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">logdet</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">])</span>
            <span class="n">ldetWishB</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">logdet</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;irate&#39;</span><span class="p">]</span>

        <span class="c1"># distance</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k_mean</span><span class="p">][</span><span class="s1">&#39;Mu&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span> <span class="o">-=</span> <span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k_beta</span><span class="p">][</span><span class="s1">&#39;Mu&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span> <span class="n">Cd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">C</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">Cd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">@</span> <span class="n">C</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span> <span class="n">dist</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cd</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># cov trace for beta</span>
        <span class="n">norm_wish_trace_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k_beta</span><span class="p">][</span><span class="s1">&#39;Sigma&#39;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">norm_wish_trace_W</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span><span class="n">jj</span><span class="p">]</span> <span class="o">@</span> <span class="n">Cb</span><span class="p">))</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="n">jj</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span>
                <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                    <span class="n">ind1</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">j1</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k_beta</span><span class="p">][</span><span class="s1">&#39;Sigma&#39;</span><span class="p">][</span><span class="n">ind1</span><span class="p">,:]</span>
                    <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                        <span class="n">ind2</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">j2</span>
                        <span class="n">norm_wish_trace_W</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">ind2</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># cov trace for mean</span>
        <span class="n">norm_wish_trace_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                    <span class="n">norm_wish_trace_mean</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k_mean</span><span class="p">][</span><span class="s1">&#39;Sigma&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm_wish_trace_mean</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k_mean</span><span class="p">][</span><span class="s1">&#39;Sigma&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">C</span><span class="p">)</span>

        <span class="n">L</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">constant</span> <span class="o">+</span> <span class="n">dist</span> <span class="o">+</span> <span class="n">norm_wish_trace_W</span> <span class="o">+</span> <span class="n">norm_wish_trace_mean</span> <span class="o">+</span> <span class="n">ldetWishB</span> <span class="o">+</span> <span class="n">PsiWish_alphasum</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__check_options</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;cyc&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;cyc_to_go_under_th&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc_to_go_under_th&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;initcyc&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;initcyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;initrep&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;initrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;tol&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;threshold_active&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;threshold_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;deactivate_states&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;deactivate_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;stochastic&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;stochastic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;updateGamma&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateGamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;updateDyn&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateDyn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;updateObs&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateObs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;verbose&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">options</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__check_options_stochastic</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="n">files</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;Nbatch&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Nbatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;initNbatch&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;initNbatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;Nbatch&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;cyc&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;initcyc&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;initcyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;forget_rate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;forget_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;base_weights&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;base_weights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;min_cyc&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;min_cyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;updateGamma&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateGamma&quot;</span><span class="p">]):</span> 
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateGamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;updateGamma has to be True for stochastic learning&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;updateDyn&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateDyn&quot;</span><span class="p">]):</span> 
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateDyn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;updateDyn has to be True for stochastic learning&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">glhmm</span><span class="o">.</span><span class="n">__check_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__check_Gamma</span><span class="p">(</span><span class="n">Gamma</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">Gamma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Gamma</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NaN were generated in the state time courses, probably due to an artifacts&quot;</span><span class="p">)</span> 
        <span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="c1">#status = (np.max(Gamma)&lt;0.6) and (np.min(Gamma)&gt;(1/K/2))</span>
        <span class="k">return</span> <span class="n">status</span>

        
    <span class="k">def</span> <span class="nf">__init_Gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">options</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;initrep&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_prior_P_Pi</span><span class="p">()</span> <span class="c1"># init P,Pi priors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_dynamics</span><span class="p">()</span> <span class="c1"># make P,Pi based on priors</span>
            <span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Gamma</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Gamma</span>

        <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;initrep&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;initrep&quot;</span><span class="p">]):</span>
            <span class="n">hmm_r</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">options_r</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="n">options_r</span><span class="p">[</span><span class="s2">&quot;cyc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options_r</span><span class="p">[</span><span class="s2">&quot;initcyc&quot;</span><span class="p">]</span>
            <span class="n">options_r</span><span class="p">[</span><span class="s2">&quot;stochastic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">options_r</span><span class="p">[</span><span class="s2">&quot;initrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">Gamma_r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">fe_r</span> <span class="o">=</span> <span class="n">hmm_r</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">options_r</span><span class="p">)</span>

            <span class="n">fe</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">r</span><span class="p">])):</span>
                <span class="n">Gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Gamma_r</span><span class="p">)</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">r</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Init repetition &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; free energy = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best repetition: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">best</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Gamma</span>
                
                
    <span class="k">def</span> <span class="nf">__update_Pi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,))</span>
        <span class="n">PsiSum0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">-</span><span class="n">PsiSum0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__update_P</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="n">PsiSum</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,:]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">-</span><span class="n">PsiSum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>


    <span class="k">def</span> <span class="nf">__Gamma_loglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">minreal</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span>
        <span class="n">Gamma_0</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">Gamma_0</span><span class="p">[</span><span class="n">Gamma_0</span> <span class="o">&lt;</span> <span class="n">minreal</span><span class="p">]</span> <span class="o">=</span> <span class="n">minreal</span>
        <span class="n">PsiDir_alphasum</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="n">L</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma_0</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">PsiDir_alphasum</span><span class="p">)</span>
        <span class="n">PsiDir2d_alphasum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span> <span class="n">PsiDir2d_alphasum</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">l</span><span class="p">,:]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="n">L</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xi</span><span class="p">[:,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">PsiDir2d_alphasum</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">L</span>


    <span class="k">def</span> <span class="nf">__update_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>      
        <span class="n">shared_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">shared_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">K_mean</span><span class="p">,</span><span class="n">K_beta</span> <span class="o">=</span> <span class="n">K</span><span class="p">,</span><span class="n">K</span>
        <span class="k">if</span> <span class="n">shared_mean</span><span class="p">:</span> <span class="n">K_mean</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shared_beta</span><span class="p">:</span> <span class="n">K_beta</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> \
                                <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]),(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>

       
    <span class="k">def</span> <span class="nf">__init_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior_shape</span><span class="p">,</span><span class="n">prior_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compute_prior_covmat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">__compute_prior_covmat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prior_shape</span><span class="p">,</span><span class="n">prior_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compute_prior_covmat</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">__compute_prior_covmat</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>         

        <span class="bp">self</span><span class="o">.</span><span class="n">__init_priors_sub</span><span class="p">(</span><span class="n">prior_rate</span><span class="p">,</span><span class="n">prior_shape</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">__init_priors_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prior_rate</span><span class="p">,</span><span class="n">prior_shape</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">shared_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">shared_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>  
        <span class="n">K_mean</span><span class="p">,</span><span class="n">K_beta</span> <span class="o">=</span> <span class="n">K</span><span class="p">,</span><span class="n">K</span>
        <span class="k">if</span> <span class="n">shared_mean</span><span class="p">:</span> <span class="n">K_mean</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shared_beta</span><span class="p">:</span> <span class="n">K_beta</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># priors for dynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_prior_P_Pi</span><span class="p">()</span>

        <span class="c1"># Covariance matrix, use the range of the global error to set the prior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_rate</span>
        <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>

        <span class="c1"># alpha (state betas and mean priors)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>        


    <span class="k">def</span> <span class="nf">__init_prior_P_Pi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="c1"># priors for dynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="c1">#self.priors[&quot;Dir_alpha&quot;][self.Pistructure] = 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir2d_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="c1">#self.priors[&quot;Dir2d_alpha&quot;][self.Pstructure[k,],:] = 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir2d_alpha&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;dirichlet_diag&quot;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__compute_prior_covmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>  

        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># iterative calculation</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                    <span class="n">_</span><span class="p">,</span><span class="n">Yj</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Yj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">nt</span> <span class="o">=</span> <span class="n">Yj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Yj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">nt</span> <span class="o">+=</span> <span class="n">Yj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">/=</span> <span class="n">nt</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                    <span class="n">Xj</span><span class="p">,</span><span class="n">Yj</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                        <span class="n">XX</span> <span class="o">=</span> <span class="n">Xj</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Xj</span>
                        <span class="n">XY</span> <span class="o">=</span> <span class="n">Xj</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Yj</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">XX</span> <span class="o">+=</span> <span class="n">Xj</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Xj</span>
                        <span class="n">XY</span> <span class="o">+=</span> <span class="n">Xj</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Yj</span>    
                <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">XX</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">Xj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">@</span> <span class="n">XY</span>   
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">Xj</span><span class="p">,</span><span class="n">Yj</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Yj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                    <span class="n">Yj</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                    <span class="n">Yj</span> <span class="o">-=</span> <span class="n">Xj</span> <span class="o">@</span> <span class="n">beta</span>
                <span class="n">rj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Yj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Yj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rj</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">T</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> 
                <span class="n">Yr</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">Yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">@</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Yr</span><span class="p">)</span>
                <span class="n">Yr</span> <span class="o">-=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">beta</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mf">0.1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#shape = 0.5 * T</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mf">0.1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#shape = T</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shape</span><span class="p">,</span><span class="n">rate</span>

  
    <span class="k">def</span> <span class="nf">__update_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">Dir_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Dir2d_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update transition prob matrix and initial probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Pistructure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pistructure&quot;</span><span class="p">]</span>
        <span class="n">Pstructure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;Pstructure&quot;</span><span class="p">]</span>

        <span class="c1"># Transition probability matrix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Xi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Dir2d_alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir2d_alpha&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Dir2d_alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Xi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Xi</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">approximate_Xi</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
                <span class="n">Dir2d_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dir2d_alpha</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir2d_alpha&quot;</span><span class="p">])</span> \
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="o">~</span><span class="n">Pstructure</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_P</span><span class="p">()</span>

        <span class="c1"># Initial probabilities</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Dir_alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir_alpha&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Dir_alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Dir_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[</span><span class="n">indices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dir_alpha</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir_alpha&quot;</span><span class="p">])</span> \
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">[</span><span class="o">~</span><span class="n">Pistructure</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_Pi</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__init_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise transition prob matrix and initial probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__update_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__update_obsdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Tfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state distributions</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">T</span><span class="p">,</span><span class="n">q</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shared_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sharedfull&#39;</span><span class="p">)</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>  
        <span class="n">shared_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">shared_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">K_mean</span><span class="p">,</span><span class="n">K_beta</span> <span class="o">=</span> <span class="n">K</span><span class="p">,</span><span class="n">K</span>
        <span class="k">if</span> <span class="n">shared_mean</span><span class="p">:</span> <span class="n">K_mean</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shared_beta</span><span class="p">:</span> <span class="n">K_beta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="n">XGX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span> <span class="n">XGX</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span>
            <span class="n">XGXb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">XGX</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">shared_beta</span> <span class="k">else</span> <span class="n">XGX</span>
        <span class="n">Gb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">shared_beta</span> <span class="k">else</span> <span class="n">Gamma</span>
        <span class="n">Gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">shared_mean</span> <span class="k">else</span> <span class="n">Gamma</span>

        <span class="c1"># Mean</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="n">Yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span> 
                    <span class="n">Yr</span> <span class="o">-=</span> <span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gb</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                    
            <span class="k">else</span><span class="p">:</span> <span class="n">Yr</span> <span class="o">=</span> <span class="n">Y</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shared_mean</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="k">continue</span>

                <span class="n">k_sigma</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">shared_covmat</span> <span class="k">else</span> <span class="n">k</span> 
                <span class="n">GY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gm</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Yr</span> 
                <span class="n">Nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gm</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                    <span class="n">isigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                    <span class="n">iS</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">isigma</span> <span class="o">*</span> <span class="n">Nk</span> <span class="o">+</span> <span class="n">alpha</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">iS</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Tfactor</span> <span class="o">*</span> <span class="n">isigma</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="n">GY</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                    <span class="n">isigma</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">])</span> 
                    <span class="n">gram</span> <span class="o">=</span> <span class="n">isigma</span> <span class="o">*</span> <span class="n">Nk</span>
                    <span class="n">maxlik_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">GY</span> <span class="o">/</span> <span class="n">Nk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">iS</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">gram</span> <span class="o">+</span> <span class="n">alpha</span>
                    <span class="n">iS</span> <span class="o">=</span> <span class="p">(</span><span class="n">iS</span> <span class="o">+</span> <span class="n">iS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Tfactor</span> <span class="o">*</span> <span class="n">S</span> <span class="o">@</span> <span class="n">gram</span> <span class="o">@</span> <span class="n">maxlik_mean</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span>

        <span class="c1"># betas </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="n">Yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span> 
                    <span class="n">Yr</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gm</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                  
            <span class="k">else</span><span class="p">:</span> <span class="n">Yr</span> <span class="o">=</span> <span class="n">Y</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shared_beta</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="k">continue</span>

                <span class="n">k_sigma</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">shared_covmat</span> <span class="k">else</span> <span class="n">k</span>
                <span class="n">XGY</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gb</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Yr</span>

                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">isigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">iS</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">isigma</span> <span class="o">*</span> <span class="n">XGXb</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span>
                        <span class="n">iS</span> <span class="o">=</span> <span class="p">(</span><span class="n">iS</span> <span class="o">+</span> <span class="n">iS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span> 
                        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">S</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Tfactor</span> <span class="o">*</span> <span class="n">isigma</span> <span class="o">*</span> <span class="n">XGY</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span>  \
                            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> \
                        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">))</span>
                    <span class="n">isigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k_sigma</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span>
                    <span class="n">gram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">XGXb</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">isigma</span><span class="p">)</span>
                    <span class="n">maxlik_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">XGXb</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">],</span><span class="n">XGY</span><span class="p">,</span><span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">],(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">iS</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">gram</span> <span class="o">+</span> <span class="n">alpha</span>
                    <span class="n">iS</span> <span class="o">=</span> <span class="p">(</span><span class="n">iS</span> <span class="o">+</span> <span class="n">iS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">S</span> <span class="o">@</span> <span class="n">gram</span> <span class="o">@</span> <span class="n">maxlik_beta</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mu</span><span class="p">,(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span>
           
        <span class="c1"># Sigma</span>
        <span class="k">if</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">T</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> 

            <span class="n">sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">if</span> <span class="n">diagonal_covmat</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> 
                <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">shared_mean</span> <span class="k">else</span> <span class="n">k</span>
                <span class="n">d</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>

            <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">if</span> <span class="n">diagonal_covmat</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> 
                <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">shared_beta</span> <span class="k">else</span> <span class="n">k</span>
                <span class="n">d</span> <span class="o">-=</span> <span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                    <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">sb</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span><span class="n">jj</span><span class="p">]</span> <span class="o">@</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span>  <span class="n">X</span><span class="p">[:,</span><span class="n">jj</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="n">j1</span>
                        <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
                            <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="n">j2</span>
                            <span class="n">sb</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]]</span> <span class="o">*</span> <span class="n">XGX</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">sb</span><span class="p">[</span><span class="n">j2</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span><span class="n">j2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">shared_covmat</span><span class="p">:</span> <span class="c1"># self.Sigma[0][&quot;rate&quot;] </span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Tfactor</span> <span class="o">*</span> \
                        <span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> \
                        <span class="o">+</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">sb</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">+=</span> <span class="n">Tfactor</span> <span class="o">*</span> \
                        <span class="p">(</span> <span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">d</span><span class="p">)</span> 
                        <span class="o">+</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">sb</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> \
                            <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Tfactor</span> <span class="o">*</span> \
                            <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> \
                            <span class="o">+</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">sb</span>
                            <span class="p">)</span> 
                    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Tfactor</span> <span class="o">*</span> \
                        <span class="p">(</span> <span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">d</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">sb</span>
                        <span class="p">)</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>   

        <span class="k">if</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rate</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">__update_priors</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__update_obsdist_stochastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">rho</span><span class="p">):</span>

        <span class="n">Tfactor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Tfactor</span><span class="p">,</span><span class="n">rho</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">__init_obsdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">):</span>
        
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shared_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sharedfull&#39;</span><span class="p">)</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span> 
        <span class="n">shared_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">shared_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">K_mean</span><span class="p">,</span><span class="n">K_beta</span> <span class="o">=</span> <span class="n">K</span><span class="p">,</span><span class="n">K</span>
        <span class="k">if</span> <span class="n">shared_mean</span><span class="p">:</span> <span class="n">K_mean</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shared_beta</span><span class="p">:</span> <span class="n">K_beta</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># alpha (keep it unregularised)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># unregularised start</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># unregularised start  </span>

        <span class="c1"># Sigma (set to priors)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">diagonal_covmat</span> <span class="ow">and</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">diagonal_covmat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">diagonal_covmat</span> <span class="ow">and</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span> <span class="c1"># not diagonal_covmat and not shared_covmat</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span>

        <span class="c1"># create initial values for mean and beta</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>  
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="c1"># do beta and mean conventionally, and redo alpha and Sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init_obsdist_stochastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Gamma</span><span class="p">):</span>

        <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init_stochastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">,</span><span class="n">options</span><span class="p">):</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;initNbatch&quot;</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
        <span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_Gamma</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_priors</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_obsdist_stochastic</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_priors</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__train_stochastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">options</span><span class="p">):</span>
        
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_options_stochastic</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="n">files</span><span class="p">)</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">__init_stochastic</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;initNbatch&quot;</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">indices_all</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">do_only_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">Gamma_subset</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">slice_matrix</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__init_priors</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__init_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">indices_all</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_obsdist_stochastic</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Gamma_subset</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_priors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trained</span> <span class="o">=</span> <span class="kc">True</span>        

        <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loglik_entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># data likelihood and Gamma likelihood &amp; entropy</span>
        <span class="n">n_used</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">sampling_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
        <span class="n">ever_used</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">sum_Gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        <span class="n">Dir_alpha_each</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        <span class="n">Dir2d_alpha_each</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        <span class="n">warm_up</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc&quot;</span><span class="p">]):</span>

            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Nbatch&quot;</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">sampling_prob</span><span class="p">)</span>
            <span class="n">n_used</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n_used</span> <span class="o">=</span> <span class="n">n_used</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">n_used</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ever_used</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">warm_up</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ever_used</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warm up finished&quot;</span><span class="p">)</span> 
                <span class="n">warm_up</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">sampling_prob</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;base_weights&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="n">n_used</span>
            <span class="n">sampling_prob</span> <span class="o">=</span> <span class="n">sampling_prob</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sampling_prob</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;forget_rate&quot;</span><span class="p">])</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Tfactor</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ever_used</span><span class="p">)</span>

            <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">indices_individual</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
            <span class="n">indices_Xi</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">Gamma_indices_to_Xi_indices</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

            <span class="c1"># E-step</span>
            <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">sum_Gamma</span><span class="p">[:,</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_FO</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            
            <span class="c1"># which states are active? </span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">warm_up</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;deactivate_states&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                    <span class="n">FO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sum_Gamma</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
                    <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">FO</span> <span class="o">&gt;</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;threshold_active&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">active_state</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is reactivated&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active_state</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is deactivated&quot;</span><span class="p">)</span>

            <span class="c1"># M-step            </span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateDyn&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Nbatch&quot;</span><span class="p">]):</span>
                    <span class="n">Dir_alpha_each</span><span class="p">[:,</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">tt_j</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">Dir2d_alpha_each</span><span class="p">[:,:,</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xi</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">Dir_alpha</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dir_alpha_each</span><span class="p">[:,</span><span class="n">ever_used</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Dir2d_alpha</span> <span class="o">=</span> <span class="n">Tfactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dir2d_alpha_each</span><span class="p">[:,:,</span><span class="n">ever_used</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_dynamics</span><span class="p">(</span><span class="n">Dir_alpha</span><span class="o">=</span><span class="n">Dir_alpha</span><span class="p">,</span><span class="n">Dir2d_alpha</span><span class="o">=</span><span class="n">Dir2d_alpha</span><span class="p">,</span><span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateObs&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Tfactor</span><span class="p">,</span><span class="n">rho</span><span class="p">)</span>

            <span class="c1"># collect subject specific free energy terms</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;Nbatch&quot;</span><span class="p">]):</span>
                <span class="n">tt_j</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tt_j_xi</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">indices_Xi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># data likelihood</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">loglik_entropy</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">Y</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span> \
                        <span class="n">Gamma</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span><span class="n">Xi</span><span class="p">[</span><span class="n">tt_j_xi</span><span class="p">,:,:],</span><span class="kc">None</span><span class="p">,</span><span class="n">indices_individual</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">todo</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loglik_entropy</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span><span class="n">Y</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span> \
                        <span class="n">Gamma</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span><span class="n">Xi</span><span class="p">[</span><span class="n">tt_j_xi</span><span class="p">,:,:],</span><span class="kc">None</span><span class="p">,</span><span class="n">indices_individual</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">todo</span><span class="p">)</span>
                <span class="c1"># Gamma likelihood and entropy</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">loglik_entropy</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">Y</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span> \
                        <span class="n">Gamma</span><span class="p">[</span><span class="n">tt_j</span><span class="p">,:],</span><span class="n">Xi</span><span class="p">[</span><span class="n">tt_j_xi</span><span class="p">,:,:],</span><span class="kc">None</span><span class="p">,</span><span class="n">indices_individual</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">todo</span><span class="p">)</span>
                              
            <span class="k">if</span> <span class="ow">not</span> <span class="n">warm_up</span><span class="p">:</span> 

                <span class="c1"># KL divergences</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">kl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">todo</span><span class="p">)</span>
                <span class="n">fe_it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kl</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loglik_entropy</span><span class="p">)</span>
                <span class="c1">#print(str(np.sum(kl)) + &#39; &#39; + str(np.sum(loglik_entropy)))</span>
                <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_it</span><span class="p">)</span> 

                <span class="k">if</span> <span class="n">fe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">chgFrEn</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chgFrEn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]:</span> <span class="n">cyc_to_go</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">cyc_to_go</span> <span class="o">=</span>  <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc_to_go_under_th&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cycle &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, free energy = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fe_it</span><span class="p">)</span> <span class="o">+</span> \
                            <span class="s2">&quot;, relative change = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chgFrEn</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, rho = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">cyc_to_go</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reached early convergence&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cycle &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; free energy = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fe_it</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cycle &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, rho = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span>

        <span class="n">K_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished stochastic training in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>  \
                    <span class="s2">&quot;s : active states = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">K_active</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fe</span>

    <span class="c1">### Public methods</span>

<div class="viewcode-block" id="glhmm.loglikelihood"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.loglikelihood">[docs]</a>    <span class="k">def</span> <span class="nf">loglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the likelihood of the model per state and time point gicven the data X and Y.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 1.</span>
<span class="sd">        Y : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        L : array of shape (n_samples, n_states)</span>
<span class="sd">            The likelihood of the model per state and time point given the data X and Y.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__loglikelihood_k</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">cache</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="glhmm.decode"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.decode">[docs]</a>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">viterbi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="nb">set</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates state time courses for all the data using either parallel or sequential processing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 1.</span>
<span class="sd">        Y : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>
<span class="sd">        indices : array-like of shape (n_sessions, 2), optional, default=None</span>
<span class="sd">            The start and end indices of each trial/session in the input data.</span>
<span class="sd">        files : list of str, optional, default=None</span>
<span class="sd">            List of filenames corresponding to the indices.</span>
<span class="sd">        viterbi : bool, optional, default=False</span>
<span class="sd">            Whether or not the Viterbi algorithm should be used.</span>
<span class="sd">        set : int, optional, default=None</span>
<span class="sd">            Index of the sessions set to decode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        If viterbi=True:</span>
<span class="sd">            vpath : array of shape (n_samples,)</span>
<span class="sd">                The most likely state sequence.</span>
<span class="sd">        If viterbi=False:</span>
<span class="sd">            Gamma : array of shape (n_samples, n_states)</span>
<span class="sd">                The state probability timeseries.</span>
<span class="sd">            Xi : array of shape (n_samples - n_sessions, n_states, n_states)</span>
<span class="sd">                The joint probabilities of past and future states conditioned on data.</span>
<span class="sd">            scale : array-like of shape (n_samples,), optional</span>
<span class="sd">                The scaling factors used to compute the free energy of the</span>
<span class="sd">                dataset. If None, scaling is automatically computed.</span>
<span class="sd">                </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">X_sliced</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">Y_sliced</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="k">if</span> <span class="nb">set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="n">X_sliced</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">slice_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="nb">set</span><span class="p">,:])</span>
            <span class="n">Y_sliced</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">slice_matrix</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="nb">set</span><span class="p">,:])</span>
            <span class="n">indices_sliced</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="nb">set</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices_sliced</span> <span class="o">=</span> <span class="n">indices</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">(</span><span class="n">X_sliced</span><span class="p">,</span><span class="n">Y_sliced</span><span class="p">))</span>

        <span class="n">minreal</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span>
        <span class="n">maxreal</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
        <span class="n">L</span><span class="p">[</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">minreal</span><span class="p">]</span> <span class="o">=</span> <span class="n">minreal</span>
        <span class="n">L</span><span class="p">[</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">maxreal</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxreal</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">viterbi</span><span class="p">:</span> 
            <span class="n">vpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__forward_backward_vp</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">indices_sliced</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vpath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__forward_backward</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">indices_sliced</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span></div>


<div class="viewcode-block" id="glhmm.sample_Gamma"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.sample_Gamma">[docs]</a>    <span class="k">def</span> <span class="nf">sample_Gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates Gamma, for timeseries of lengths specified in variable size.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size : array</span>
<span class="sd">            Array of shape (n_sessions,) or (n_sessions, 2). If `size` is 1-dimensional,</span>
<span class="sd">            each element represents the length of a session. If `size` is 2-dimensional,</span>
<span class="sd">            each row of `size` represents the start and end indices of a session in a timeseries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma : array of shape (n_samples, n_states)</span>
<span class="sd">            The state probability timeseries.    </span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="c1">#if not self.trained: </span>
        <span class="c1">#    raise Exception(&quot;The model has not yet been trained&quot;) </span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># T</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">size</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">make_indices_from_T</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># indices</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">size</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">Gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="n">K</span><span class="p">))</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">K</span><span class="p">))</span>
            <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gamma</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">gamma</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
            <span class="n">Gamma</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">gamma</span>

        <span class="k">return</span> <span class="n">Gamma</span></div>


<div class="viewcode-block" id="glhmm.sample"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates Gamma and Y for timeseries of lengths specified in variable size.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size : array of shape (n_sessions,) or (n_sessions, 2)</span>
<span class="sd">            If `size` is 1-dimensional, each element represents the length of a session. If `size` is 2-dimensional,</span>
<span class="sd">            each row of `size` represents the start and end indices of a session in a timeseries.</span>
<span class="sd">        X : array of shape (n_samples, n_parcels), default=None</span>
<span class="sd">            The timeseries of set of variables 1. </span>
<span class="sd">        Gamma : array of shape (n_samples, n_states), default=None</span>
<span class="sd">            The state probability timeseries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma : array of shape (n_samples, n_states)</span>
<span class="sd">            The state probability timeseries.</span>
<span class="sd">        Y: array of shape (n_samples,n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>
<span class="sd">        If X=None:</span>
<span class="sd">            X : array of shape (n_samples, n_parcels)</span>
<span class="sd">               The timeseries of set of variables 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">shared_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sharedfull&#39;</span><span class="p">)</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>  

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># T</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">size</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">auxiliary</span><span class="o">.</span><span class="n">make_indices_from_T</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># indices</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">size</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Gamma</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># Y, mean</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="n">q</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Mu&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">+=</span> <span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span>
            
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span> 
                <span class="n">Y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Y, covariance</span>
        <span class="k">if</span> <span class="n">shared_covmat</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">scale</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">cov</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                    <span class="n">Y</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">scale</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  \
                        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Y</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">cov</span><span class="o">=</span><span class="n">C</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> \
                        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span></div>

            
<div class="viewcode-block" id="glhmm.get_fe"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.get_fe">[docs]</a>    <span class="k">def</span> <span class="nf">get_fe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">todo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the Free Energy of an HMM depending on observation model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 1.</span>
<span class="sd">        Y : array of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>
<span class="sd">        Gamma : array of shape (n_samples, n_states), default=None</span>
<span class="sd">            The state timeseries probabilities.</span>
<span class="sd">        Xi : array-like of shape (n_samples - n_sessions, n_states, n_states)</span>
<span class="sd">            The joint probabilities of past and future states conditioned on data.</span>
<span class="sd">        scale : array-like of shape (n_samples,), default=None</span>
<span class="sd">            The scaling factors used to compute the free energy of the</span>
<span class="sd">            dataset. If None, scaling is automatically computed.</span>
<span class="sd">        indices : array-like of shape (n_sessions, 2), optional, default=None</span>
<span class="sd">            The start and end indices of each trial/session in the input data.</span>
<span class="sd">        todo:  bool of shape (n_terms,) or None, default=None</span>
<span class="sd">            Whether or not each of the 5 elements (see `fe_terms`) should be computed.</span>
<span class="sd">                </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fe_terms : array of shape (n_terms,)</span>
<span class="sd">            The variational free energy, separated into different terms:</span>
<span class="sd">        </span>
<span class="sd">            - element 1: Gamma Entropy</span>
<span class="sd">            - element 2: Data negative log-likelihood</span>
<span class="sd">            - element 3: Gamma negative log-likelihood</span>
<span class="sd">            - element 4: KL divergence for initial and transition probabilities</span>
<span class="sd">            - element 5: KL divergence for the state parameters</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function computes the variational free energy using a specific algorithm. For more information on the algorithm, see [1^].</span>
<span class="sd">        </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        [1^] Smith, J. et al. &quot;A variational approach to Bayesian learning of switching dynamics in dynamical systems.&quot; Journal of Machine Learning Research, vol. 18, no. 4, 2017.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">todo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Gamma_entropy, data loglik, Gamma loglik, P/Pi KL, state KL </span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>
        <span class="n">shared_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sharedfull&#39;</span><span class="p">)</span>
        <span class="n">diagonal_covmat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shareddiag&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;covtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">)</span>  
        <span class="n">shared_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">shared_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shared&#39;</span>
        <span class="n">K_mean</span><span class="p">,</span><span class="n">K_beta</span> <span class="o">=</span> <span class="n">K</span><span class="p">,</span><span class="n">K</span>
        <span class="k">if</span> <span class="n">shared_mean</span><span class="p">:</span> <span class="n">K_mean</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shared_beta</span><span class="p">:</span> <span class="n">K_beta</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">todo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># standard way</span>
            <span class="n">use_scale</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fe_some_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">fe_some_terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">Gamma_entropy</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">fe_some_terms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">Gamma</span><span class="p">)</span>     
            <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">fe_some_terms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__Gamma_loglikelihood</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>     
            
        <span class="k">else</span><span class="p">:</span> <span class="c1"># short way if we have the scale variables from the forward-backward algorithm </span>
            <span class="n">use_scale</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fe_some_terms</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="c1"># (only valid just after)</span>

        <span class="n">kldyn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">kldyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">dirichlet_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir_alpha</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir_alpha&quot;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="n">kldyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">dirichlet_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dir2d_alpha</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Dir2d_alpha&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">,:]))</span>

        <span class="n">klobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_mean</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                            <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gauss1d_kl</span><span class="p">(</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> \
                                <span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> \
                            <span class="p">))</span>
                            <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> \
                            <span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gauss_kl</span><span class="p">(</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">],</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span> \
                        <span class="p">))</span>
                        <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_mean&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> \
                        <span class="p">)))</span>   

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K_beta</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;connectivity&quot;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
                            <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gauss_kl</span><span class="p">(</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">jj</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">j</span><span class="p">],</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pj</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span> \
                            <span class="p">))</span>
                            <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> \
                            <span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gauss_kl</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">],(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">,)),</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Sigma&quot;</span><span class="p">],</span>\
                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">,))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span> \
                        <span class="p">))</span>
                        <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span>\
                                <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">,)),</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span>\
                                <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;alpha_beta&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">,))</span> \
                        <span class="p">)))</span>      

            <span class="k">if</span> <span class="n">shared_covmat</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">diagonal_covmat</span><span class="p">):</span>
                <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">wishart_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shared_covmat</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">diagonal_covmat</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                    <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">wishart_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">shared_covmat</span> <span class="ow">and</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shared_covmat</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diagonal_covmat</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                    <span class="n">klobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">gamma_kl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">[</span><span class="s2">&quot;Sigma&quot;</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">])))</span>

        <span class="k">if</span> <span class="n">use_scale</span><span class="p">:</span>
            <span class="n">fe_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fe_terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fe_some_terms</span><span class="p">)</span>
            <span class="n">fe_terms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kldyn</span><span class="p">)</span>
            <span class="n">fe_terms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klobs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fe_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">fe_terms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_some_terms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">fe_terms</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kldyn</span><span class="p">)</span>
            <span class="n">fe_terms</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klobs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fe_terms</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="glhmm.get_covariance_matrix"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.get_covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the covariance matrix for the specified state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            The index of the state. Default=0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array of shape (n_parcels, n_parcels)</span>
<span class="sd">            The covariance matrix for the specified state.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="glhmm.get_inverse_covariance_matrix"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.get_inverse_covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_inverse_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the inverse covariance matrix for the specified state.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            The index of the state. Default=0.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array of shape (n_parcels, n_parcels)</span>
<span class="sd">            The inverse covariance matrix for the specified state.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;irate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="glhmm.get_beta"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.get_beta">[docs]</a>    <span class="k">def</span> <span class="nf">get_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the beta of the specified state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            The index of the state for which to retrieve the beta value. Default=0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The beta value of the specified state.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not yet been trained.</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has no beta.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_beta&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has no beta&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="glhmm.get_mean"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.get_mean">[docs]</a>    <span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the mean of the specified state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            The index of the state for which to retrieve the mean. Default=0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The mean value of the specified component.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not yet been trained.</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has no mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;model_mean&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has no mean&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Mu&quot;</span><span class="p">]</span></div>
    

<div class="viewcode-block" id="glhmm.dual_estimate"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.dual_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">dual_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dual estimation of HMM parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 1.</span>
<span class="sd">        Y : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>
<span class="sd">        indices : array-like of shape (n_sessions, 2), optional</span>
<span class="sd">            The start and end indices of each trial/session in the input data. If None, a single</span>
<span class="sd">            segment spanning the entire sequence is used.</span>
<span class="sd">        Gamma : array-like of shape (n_samples, n_states), optional</span>
<span class="sd">            The state probabilities. If None, it is computed from the input</span>
<span class="sd">            observations.</span>
<span class="sd">        Xi : array-like of shape (n_samples - n_sessions, n_states, n_states), optional</span>
<span class="sd">            The joint probabilities of past and future states conditioned on data. If None, it is computed from the input observations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hmm_dual : object</span>
<span class="sd">            A copy of the HMM object with updated dynamics and observation</span>
<span class="sd">            distributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The model has not yet been trained&quot;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># one big chunk with no cuts</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hmm_dual</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>

        <span class="n">hmm_dual</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">hmm_dual</span><span class="o">.</span><span class="n">update_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">hmm_dual</span><span class="o">.</span><span class="n">update_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>

        <span class="c1"># for j in range(N):</span>
        <span class="c1">#     tt = np.arange(indices[j,0],indices[j,1])</span>
        <span class="c1">#     tt_xi = tt[0:-1] - j</span>
        <span class="c1">#     indices_j = np.zeros((1,2)).astype(int)</span>
        <span class="c1">#     indices_j[0,1] = indices[j,1] - indices[j,0]</span>
        <span class="c1">#     hmm_dual.append = copy.deepcopy(self)</span>
        <span class="c1">#     hmm_dual[j].update_dynamics(Gamma[tt,:],Xi[tt_xi,:,:],indices_j)</span>
        <span class="c1">#     hmm_dual[j].update_obsdist(X[tt,:],Y[tt,:],Gamma[tt,:])</span>

        <span class="k">return</span> <span class="n">hmm_dual</span></div>


<div class="viewcode-block" id="glhmm.train"><a class="viewcode-back" href="../../glhmm.html#glhmm.glhmm.glhmm.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the HMM on input data X and Y.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 1.</span>
<span class="sd">        Y : array-like of shape (n_samples, n_parcels)</span>
<span class="sd">            The timeseries of set of variables 2.</span>
<span class="sd">        indices : array-like of shape (n_sessions, 2), optional</span>
<span class="sd">            The start and end indices of each trial/session in the input data.</span>
<span class="sd">            If None, one big segment with no cuts is assumed.</span>
<span class="sd">        files : str or list of str, optional</span>
<span class="sd">            The filename(s) containing the data to load. If not None,</span>
<span class="sd">            X, Y, and indices are ignored.</span>
<span class="sd">        Gamma : array-like of shape (n_samples, n_states), optional</span>
<span class="sd">            The initial values of the state probabilities.</span>
<span class="sd">        Xi : array-like of shape (n_samples - n_sessions, n_states, n_states), optional</span>
<span class="sd">            The joint probabilities of past and future states conditioned on data.</span>
<span class="sd">        scale : array-like of shape (n_samples,), optional</span>
<span class="sd">            The scaling factors used to compute the free energy of the</span>
<span class="sd">            dataset. If None, scaling is automatically computed.</span>
<span class="sd">        options : dict, optional</span>
<span class="sd">            A dictionary with options to control the training process.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma : array-like of shape (n_samples, n_states)</span>
<span class="sd">            The state probabilities.</span>
<span class="sd">        Xi : array-like of shape (n_samples - n_sessions, n_states, n_states)</span>
<span class="sd">            The joint probabilities of past and future states conditioned on data.</span>
<span class="sd">        fe : array-like</span>
<span class="sd">            The free energy computed at each iteration of the training process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Argument &#39;files&#39; cannot be used if the data (Y) is also provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Training needs data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;stochastic&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;stochastic&quot;</span><span class="p">]):</span>
            <span class="n">fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__train_stochastic</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fe</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># one big chunk with no cuts</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trained</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">Gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_Gamma</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_priors</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_priors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trained</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cyc_to_go</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc_to_go_under_th&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc&quot;</span><span class="p">]):</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateGamma&quot;</span><span class="p">]:</span>

                <span class="c1"># E-step</span>
                <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_Gamma</span><span class="p">(</span><span class="n">Gamma</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Gamma has almost zero variance: stuck in a weird solution&#39;</span><span class="p">)</span>
                
                <span class="c1"># which states are active? </span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;deactivate_states&quot;</span><span class="p">]:</span>
                    <span class="n">FO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                        <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">FO</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;threshold_active&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">active_state</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is reactivated&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">active_state</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is deactivated&quot;</span><span class="p">)</span>

                <span class="c1"># epsilon = 1</span>
                <span class="c1"># while status:</span>
                <span class="c1">#     self.perturb(epsilon)</span>
                <span class="c1">#     Gamma,Xi,scale = self.decode(X,Y,indices)</span>
                <span class="c1">#     status = self.__check_Gamma(Gamma)</span>
                <span class="c1">#     epsilon *= 2</span>

            <span class="c1"># if we use the scale to compute the FE, it&#39;s only valid after the E-step</span>
            <span class="n">fe_it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">scale</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_it</span><span class="p">)</span> 

            <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chgFrEn</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chgFrEn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]:</span> <span class="n">cyc_to_go</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">cyc_to_go</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cyc_to_go_under_th&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cycle &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, free energy = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fe_it</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s2">&quot;, relative change = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chgFrEn</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">cyc_to_go</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reached early convergence&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cycle &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; free energy = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fe_it</span><span class="p">))</span>

            <span class="c1"># M-step</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateDyn&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_dynamics</span><span class="p">(</span><span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">indices</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;updateObs&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_obsdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Gamma</span><span class="p">)</span>
                
        <span class="n">K_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_states</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished training in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>  \
                    <span class="s2">&quot;s : active states = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">K_active</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Gamma</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">fe</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Diego Vidaurre.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>